name: åŒæ­¥TVlive2ä»“åº“æ›´æ–°

on:
  schedule:
    - cron: '0 */8 * * *'  # æ¯8å°æ—¶è§¦å‘ä¸€æ¬¡
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}  # ä½¿ç”¨é»˜è®¤tokenç¡®ä¿æ¨é€æƒé™
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•

      - name: è®¾ç½®Gité…ç½®
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'

      - name: æ·»åŠ æºä»“åº“è¿œç¨‹å¹¶åŒæ­¥
        run: |
          # æºä»“åº“åœ°å€ï¼ˆå…¬å¼€ä»“åº“ï¼Œç›´æ¥ä½¿ç”¨HTTPSï¼‰
          SOURCE_REPO="https://github.com/xcpab/tvlive.git"
          
          # æ·»åŠ æºä»“åº“è¿œç¨‹
          git remote add upstream $SOURCE_REPO || true
          
          # è·å–æºä»“åº“mainåˆ†æ”¯æœ€æ–°å˜åŒ–
          git fetch upstream main
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–°commit
          if [ "$(git rev-list --count HEAD...upstream/main 2>/dev/null || echo 0)" -gt 0 ]; then
            echo "âœ… æ£€æµ‹åˆ°xcpab/tvliveä»“åº“æœ‰æ›´æ–°ï¼Œå¼€å§‹åŒæ­¥..."
            
            # åˆ‡æ¢åˆ°mainåˆ†æ”¯
            git checkout main
            
            # åˆå¹¶ä¸Šæ¸¸å˜åŒ–ï¼ˆå…è®¸æ— å…³å†å²ï¼‰
            git merge upstream/main --allow-unrelated-histories -m "åŒæ­¥xcpab/tvliveæœ€æ–°æ›´æ–°"
            
            # æ¨é€æ›´æ–°åˆ°ç›®æ ‡ä»“åº“
            git push origin main
            
            echo "ğŸ‰ åŒæ­¥å®Œæˆï¼å·²æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ã€‚"
          else
            echo "â„¹ï¸ xcpab/tvliveä»“åº“æš‚æ— æ›´æ–°ã€‚"
          fi

      - name: æ¸…ç†è¿œç¨‹æº
        if: always()
        run: |
          git remote remove upstream || true
          echo "æ¸…ç†å®Œæˆã€‚"

      - name: æ£€æŸ¥åŒæ­¥çŠ¶æ€
        if: always()
        run: |
          echo "=== åŒæ­¥ä»»åŠ¡çŠ¶æ€æŠ¥å‘Š ==="
          echo "æºä»“åº“: https://github.com/xcpab/tvlive"
          echo "ä¸‹æ¬¡æ£€æŸ¥æ—¶é—´: çº¦8å°æ—¶åï¼ˆ$(date -d '+8 hours' '+%Y-%m-%d %H:%M:%S %Z')ï¼‰"
